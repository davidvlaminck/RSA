from DQReport import DQReport


class Report0107:
    def __init__(self):
        self.report = None

    def init_report(self):
        self.report = DQReport(name='report0107', title='Geometrie is geldig: in Vlaanderen gelegen',
                               spreadsheet_id='1aUVoYhqKe1k4KwuAyNcfWXkH9uwj1Cls_ufH2j37gNg', datasource='PostGIS',
                               persistent_column='D')

        self.report.result_query = """
            WITH cte_bbox_vlaanderen (geom) AS (
                values(
                    ST_SetSRID(ST_GeomFromText(
                    -- Bounding box rondom Vlaanderen met een 1 km buffer en coordinaten gegeneraliseerd tot op 500 meter.
                    -- Co√∂rdinaten afgerond tot op 1 meter.
                    -- Donut holes opgevuld
                    '
                    MULTIPOLYGON (((255283 156375,251372 156165,249347 159629,245640 159269,242793 159920,241583 161839,242185 162602,246054 163199,248836 165559,250209 165468,250412 164181,251951 162755,254171 163796,257840 164079,259858 159047,257744 155805,255283 156375)),((191308 239032,191562 237245,190762 235711,193230 237903,193705 240930,195732 243149,197109 243079,197697 241388,200076 241143,202195 236153,200094 231918,203976 227241,204332 223900,208209 225008,211724 222733,210983 218359,216952 218475,218146 219932,222814 218631,227361 222782,230483 222126,233958 218140,234145 213881,239769 211651,240854 210240,246782 210707,249352 209095,249620 207395,252204 208384,255055 205421,253839 202760,252139 201774,253413 200878,253435 199182,251521 198080,251198 194964,249364 194304,248771 192731,249753 191400,249156 188368,246893 185377,248284 184539,248598 182909,245954 177820,244421 177460,242705 174267,241765 174289,240801 173118,241355 169771,243926 168117,243699 166091,241350 165847,237979 162475,232671 160518,232488 159183,228865 156629,224058 155982,221397 158506,219730 159027,216606 155586,214379 156555,213130 155431,209230 155966,206497 153138,204984 153156,202502 154507,201474 153987,198953 154490,196795 156544,196562 158491,194238 160906,188772 158304,187309 159205,186958 160538,182184 160715,179293 164514,176968 165128,174896 163321,170639 163723,170146 162574,171160 160103,169479 158326,166246 158025,165328 158939,163065 158444,160801 156409,156708 159244,154352 157468,151253 156866,150624 155139,146903 154994,146452 153736,144599 152693,142802 153253,140774 152343,138362 154338,136122 154222,135029 156184,131087 153987,129583 154576,128366 152773,127180 153276,124523 152974,123508 152087,119094 152211,117174 152618,115300 155124,115309 158895,112228 158099,110242 159106,107838 158860,106041 161531,103810 161135,102443 161757,99742 158405,99359 156425,97813 155952,95908 157179,93206 156816,91033 157527,90541 160623,88534 160145,86317 160728,82899 158919,81680 157207,80228 156964,78842 154819,75289 156817,74704 159632,71934 159594,69137 161167,67254 160163,65457 160301,63259 163896,61819 163863,59796 162280,57600 163108,56245 162078,54832 162178,53879 162899,53144 166198,51100 165272,51670 163119,48961 161926,48277 160603,43785 160626,43612 159123,45157 156586,43883 155338,42100 156780,40090 156256,37734 157718,36955 160520,33324 165289,32898 167316,27551 167357,26303 170285,24312 172201,25226 174319,24874 178784,23976 180467,26709 183689,25236 187396,22973 189636,22397 196350,19913 201703,20214 202516,24994 204848,25355 205859,36018 210723,45934 217260,46663 218428,48713 218870,58549 225421,63783 227726,64608 228653,64191 229846,66228 231670,69258 231476,71246 230059,79676 232560,82316 226444,82354 224873,80902 223271,82161 221446,81559 221103,82123 219422,85579 216161,90129 216369,89846 220920,94266 221842,95838 223143,99128 221256,100850 221187,104323 219236,107010 219086,110725 217174,110563 212634,114313 212528,116274 213734,117746 212550,118880 213417,120715 212890,125013 216050,127840 215796,135177 221100,139691 226870,138385 229565,138943 230332,147947 230779,148865 228656,151368 228282,152923 229095,149988 234529,150725 236408,150029 236644,149872 238058,157109 241904,162430 242242,163484 240239,162230 237609,162404 236235,164369 236939,169819 236271,169954 237960,171877 238990,175938 244131,178203 245104,181281 243985,182237 242484,183802 241814,184091 238802,182756 236699,183918 235006,186972 236042,187452 238193,189469 239632,191308 239032)))
                    '
                    ), 31370)
                )
            ), cte_asset_withGeom as (
                select a.uuid, a.assettype, g.wkt_string, st_setsrid(st_geomfromtext(g.wkt_string), 31370) as geom 
                from assets a
                left join geometrie g on a.uuid = g.assetuuid
                where
                    a.actief = true
                    and
                    g.wkt_string is not null
            )
            select
                a.uuid
                , at.label
                , left(a.wkt_string, 50000) as wkt_string
            FROM cte_asset_withGeom a
            left join cte_bbox_vlaanderen bbox on st_within(a.geom, bbox.geom)
            left join assettypes at on a.assettype =  at.uuid
            where bbox.geom is null
            ;
	"""

    def run_report(self, sender):
        self.report.run_report(sender=sender)
