from DQReport import DQReport


class Report0107:
    def __init__(self):
        self.report = None

    def init_report(self):
        self.report = DQReport(name='report0107', title='Geometrie is geldig: in Vlaanderen gelegen',
                               spreadsheet_id='1aUVoYhqKe1k4KwuAyNcfWXkH9uwj1Cls_ufH2j37gNg', datasource='PostGIS',
                               persistent_column='D')

        self.report.result_query = """
        WITH cte_bbox (geom) AS (
            values(
                ST_SetSRID(ST_GeomFromText(
                'MULTIPOLYGON (((247637.8178504946 169438.5857489207,260990.79620752682 167272.11536336326,264010.06598866265 159927.1203795833,260728.0743607021 152501.56793209427,248676.06598307888 152741.3727974606,238660.6531400882 158117.18594587577,228041.28732460082 151614.46237997792,220234.71324499152 153585.26075869167,202530.8170328644 149279.06247925924,177181.65181372402 160045.16867529863,170191.0872936623 153957.52848665326,155897.04787051977 153772.63868684004,141103.56964838968 148027.75160635967,133389.8162290467 150652.59712977038,118308.79144208647 147708.13965815815,104063.11582728142 156853.62482587592,96572.46369498102 151924.89360658426,87083.476775471 156236.34805713242,78660.02225207107 150204.90151700695,61409.351573931366 158596.84046599572,52161.33387487927 158650.13246782243,41920.35311751818 151277.80810137594,21562.27470168665 168651.9456685301,21805.085496945292 184167.49319999618,16561.50624169512 199586.82934938784,66647.5351239782 233696.36334209645,83430.87393944738 233968.29971013268,86080.15975339709 222494.79388115986,96518.71396036012 227356.1711817203,119281.4070680487 217381.67206048264,132372.6236542907 224007.0704663494,136794.57230081208 234231.97707146092,145855.26804096147 234685.56100234244,147825.5036885696 242289.23958643232,155531.8407495911 245659.7908455896,162410.59984526367 246601.33478148762,167425.84058865457 241129.1879031689,177223.34541748403 248991.87012949196,190603.74652216517 243741.66038808125,198784.8474141894 247088.1898608431,203423.45703273092 243747.44195205817,204906.2377268043 232539.8972892212,215804.17383692035 223277.60303640456,232343.18337133186 225810.11661211037,238087.95295339663 216639.35163461458,259111.19803081988 207424.54352165334,247637.8178504946 169438.5857489207)))'
                ), 31370)
            )
        ), cte_asset_withGeom as (
            select a.uuid, g.wkt_string, st_setsrid(st_geomfromtext(g.wkt_string), 31370) as geom 
            from assets a
            left join geometrie g on a.uuid = g.assetuuid
            where
                a.actief = true
                and
                g.wkt_string is not null
        )
        select a.*
        FROM cte_asset_withGeom a
        left join cte_bbox bbox on st_within(a.geom, bbox.geom) where bbox.geom is null;
	"""

    def run_report(self, sender):
        self.report.run_report(sender=sender)
